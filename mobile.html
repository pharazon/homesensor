<!DOCTYPE html> 
<html> 
<head> 
    <title>Lämpötila</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"> 	
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0-rc.2/jquery.mobile-1.2.0-rc.2.min.css" />
    <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.2.0-rc.2/jquery.mobile-1.2.0-rc.2.min.js"></script>

    <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/datebox/latest/jqm-datebox.min.css" />
    <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/latest/jqm-datebox.core.min.js"></script>
    <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/latest/jqm-datebox.mode.calbox.min.js"></script>
    <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/i18n/jquery.mobile.datebox.i18n.en_US.utf8.js"></script> 
</head> 
<body> 

<div data-role="page" id="mainPage">

    <div data-role="header" data-position="fixed">
        <a href="#" data-role="button" data-icon="refresh" id="refreshButton">Päivitä</a>
        <h1>Lämpötila</h1>
    </div><!-- /header -->

    <div data-role="content">	
        <ul data-role="listview" id="sensorlist">
        </ul>
    </div>

    <div data-role="footer" class="ui-bar" data-position="fixed">
    	<a href="#graphPage" data-role="button" data-icon="arrow-r" id="graphButton">Katso</a>
    </div>


</div><!-- /page -->

<div data-role="page" id="graphPage">

    <div data-role="header" id="header" data-position="fixed">
    	<a href="#mainPage" data-role="button" data-icon="arrow-l">Takaisin</a>
        <h1>Lämpötila</h1>
    </div><!-- /header -->

    <div data-role="content">
        <div id="graphImage"></div>
        <div id="graphStats">
            <ul data-role="listview" id="sensorStatView"></ul>
        </div>
    </div>

    <div data-role="footer" class="ui-bar" id="footer" data-position="fixed">
    	<select name="hours" id="timeSelect">
            <option value="12">12 tuntia</option>
            <option selected value="24">1 päivä</option>
            <option value="72">3 päivää</option>
            <option value="168">1 viikko</option>
            <option value="custom">Tarkemmin...</option>
        </select>
    </div>


</div><!-- /page -->

<div data-role="dialog" id="timeDialog">

    <div data-role="header">
        <h1>Valitse alku- ja loppuaika</h1>
    </div><!-- /header -->

    <div data-role="content">
        <label for="startDate">Alkuaika</label>
        <input name="startDate" id="startDate" type="date" data-role="datebox" data-options='{"mode": "calbox"}'>
        <label for="endDate">Loppuaika</label>
        <input name="endDate" id="endDate" type="date" data-role="datebox" data-options='{"mode": "calbox"}'>
    	<a href="#graphPage" id="dateDialogCloseButton" data-role="button" date-rel="back" data-theme="b">Aseta</a>
    </div>

</div><!-- /dialog -->

<script>
jQuery.extend(jQuery.mobile.datebox.prototype.options, {
    'overrideDateFormat': '%d.%m.%Y',
    'overrideHeaderFormat': '%d.%m.%Y'
});

var sersordata;
var selected_index = [];
var imageHeight;
var imageWidth;

$(document).bind("pageinit", function(event) {
    checkboxRefresh();
});
    
    $("#sensorlist").on("click", ' > li', function(event) {
        if (selected_index[$(this).index()] == true) {
            selected_index[$(this).index()] = false;
            $(this).removeClass("ui-btn-up-b");
            $(this).removeClass("ui-btn-hover-b");
            $(this).addClass("ui-btn-up-a");
            $(this).attr("data-theme", "a");
        }
        else {
            selected_index[$(this).index()] = true;
            $(this).removeClass("ui-btn-up-a");
            $(this).removeClass("ui-btn-hover-a");
            $(this).addClass("ui-btn-up-b");
            $(this).attr("data-theme", "b");
        }
    });
    
    $("#timeSelect").change(function () {
        var selected = $("#timeSelect option:selected").attr("value");
        if (selected == "custom") {
            $.mobile.changePage('#timeDialog', 'pop', true, true);
        } else
            graphRefresh(buildGraphQuery(sensordata, selected_index));
    });

    $("#graphButton").on("click", function(event) {
        //graphRefresh(buildGraphQuery(sensordata, selected_index));
    });

    $("#refreshButton").on("click", function(event) {
        checkboxRefresh();
        selected_index = []
    });
    
    $("#dateDialogCloseButton").on("click", function(event) {
        //graphRefresh(buildGraphQuery(sensordata, selected_index));
    });

$("#graphPage").on("pageshow", function(event) {
    graphRefresh(buildGraphQuery(sensordata, selected_index));
});

$("#graphPage").on("orientationchange", function(event) {
    graphRefresh(buildGraphQuery(sensordata, selected_index));
});

function parseDate(datestring) {
    var datearray = datestring.split(".");
    var date = new Date();
    date.setFullYear(datearray[2]);
    date.setMonth(datearray[1]);
    date.setDate(datearray[0]);
    return date;
}

function checkboxRefresh(){
    $.mobile.loading( 'show' );
    $.getJSON('sensor.php', function(data) {
        $('#sensorlist').empty();
        $.each(data, function(i,sensor) {
            item = '<li data-icon="false" data-theme="a" id="' + sensor.id + '"><a href=#>' + sensor.name +" " + sensor.value +" "+ sensor.unit +'</a></li>';
            $('#sensorlist').append(item);
        })
        $("#sensorlist").listview("refresh");
        sensordata = data;
        $.mobile.loading( 'hide' );
    });
}

function graphRefresh(query) {
    $.mobile.loading( 'show' );
    $.getJSON(query, function(sensors) {
        $('#graphImage').empty();
        $('#sensorStatView').empty();
        $('#graphImage').append(sensors.graphImage);
        $.each(sensors.data, function(i, data){
          item = "<li><h3>"+data.name+"</h3><p>Keskiarvo: "+data.avg+" "+ data.unit +"</p><p>Maksimi: "+data.max+" "+ data.unit +"</p><p>Minimi: "+data.min+" "+ data.unit +"</p></li>";
          $('#sensorStatView').append(item);
        });
        
        $('#sensorStatView').listview('refresh');
        $.mobile.loading( 'hide' );
    });
}


function buildGraphQuery(sensors, selected) {
    imageHeight = $(window).height() - $("#header").height() - $("#footer").height() - 50;
    imageWidth = $(window).width() - 25;
    var graphQuery = "graph.php?fullscreen=1&dataFormat=json&";
    $.each(sensors, function(i, sensor){
        if (selected[i] == true)
            graphQuery = graphQuery+'sensor[]='+sensor.id+'&';
    });

    var hours = $("#timeSelect option:selected").attr("value")
    if (hours == "custom") {
        var startDate = parseDate($("#startDate").val());
        var endDate = parseDate($("#endDate").val());
        endDate.setDate(endDate.getDate()+1);
        var startDateString = ''+startDate.getFullYear()+'-'+startDate.getMonth()+'-'+startDate.getDate()+'-00-00-00';
        var endDateString = ''+endDate.getFullYear()+'-'+endDate.getMonth()+'-'+endDate.getDate()+'-00-00-00';
        graphQuery = graphQuery+'dateStart='+startDateString+'&dateEnd='+endDateString+'&';
    } else {
        graphQuery = graphQuery+'hours='+hours+'&';
    }

    graphQuery = graphQuery+'width='+imageWidth+'&height='+imageHeight+'&';
    return graphQuery;
}
</script>

</body>
</html>

